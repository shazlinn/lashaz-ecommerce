// Path: prisma/schema.prisma

// This specifies the Prisma Client generator.
generator client {
  provider = "prisma-client-js"
}

// This defines the database provider.
// NOTICE: The 'url' line is REMOVED from here. This is the main fix for the P1012 error.
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserStatus {
  active
  deactivated
}

// ---------------------------------
// --- APPLICATION MODELS
// ---------------------------------

// Holds data for registered users (customers and admins)
model User {
  id             String    @id @default(cuid())
  name           String?
  email          String    @unique
  hashedPassword String
  role           String    @default("customer") // e.g., "customer" or "admin"
  status         UserStatus  @default(active)   // <--- NEW
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  addresses Address[]
  orders    Order[]
  cart      Cart?
  sessions  ChatbotSession[]
}

// Stores user shipping and billing addresses
model Address {
  id         String @id @default(cuid())
  street     String
  city       String
  state      String
  postalCode String
  country    String
  userId     String
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Represents a product in the store
model Product {
  id          String   @id @default(cuid())
  name        String
  description String
  price       Decimal  @db.Decimal(10, 2)
  stock       Int
  imageUrl    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  categoryId  String
  
  // Relations
  category  Category     @relation(fields: [categoryId], references: [id])
  tags      ProductTag[]
  cartItems CartItem[]
  orderItems OrderItem[]
}

// Groups products into categories like "Skincare", "Makeup"
model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  
  // Relations
  products Product[]
}

// Represents keywords to tag products for better searching
model Tag {
  id   String @id @default(cuid())
  name String @unique

  // Relations
  products ProductTag[]
}

// A join table for the many-to-many relationship between Products and Tags
model ProductTag {
  productId String
  tagId     String
  
  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([productId, tagId])
}


// Stores the customer's shopping cart
model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
}

// Represents a single item within a shopping cart
model CartItem {
  id        String   @id @default(cuid())
  quantity  Int
  cartId    String
  productId String

  // Relations
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

// Records a customer's completed order
model Order {
  id              String      @id @default(cuid())
  status          String      // e.g., "pending", "paid", "shipped", "delivered"
  totalAmount     Decimal     @db.Decimal(10, 2)
  trackingNumber  String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  userId          String

  // Relations
  user            User        @relation(fields: [userId], references: [id])
  items           OrderItem[]
  transaction     PaymentTransaction?
}

// Represents a single item within an order
model OrderItem {
  id              String   @id @default(cuid())
  quantity        Int
  priceAtPurchase Decimal  @db.Decimal(10, 2)
  orderId         String
  productId       String

  // Relations
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product         Product  @relation(fields: [productId], references: [id])
}

// Logs payment details for each order
model PaymentTransaction {
  id               String   @id @default(cuid())
  orderId          String   @unique
  method           String   // e.g., "FPX"
  amount           Decimal  @db.Decimal(10, 2)
  status           String   // e.g., "success", "failed"
  transactionDate  DateTime @default(now())
  fpxRefId         String?  // Reference ID from the payment gateway
  
  // Relations
  order            Order    @relation(fields: [orderId], references: [id])
}

// Stores questions and answers for the chatbot
model FAQ {
  id       String    @id @default(cuid())
  question String
  answer   String
  category String? // e.g., "shipping", "returns"
}

// Stores a log of chatbot interactions
model ChatbotSession {
  id        String   @id @default(cuid())
  userId    String?  // Can be null for guest users
  startedAt DateTime @default(now())
  endedAt   DateTime?

  // Relations
  user      User?    @relation(fields: [userId], references: [id])
}